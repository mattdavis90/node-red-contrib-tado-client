<script type="text/x-red" data-template-name="tado-config">
    <div class="form-row">
        <label for="node-config-input-username"><i class="fa fa-user"></i> <span data-i18n="node-red:common.label.username"></span></label>
        <input type="text" id="node-config-input-username">
    </div>
    <div class="form-row">
        <label for="node-config-input-password"><i class="fa fa-lock"></i> <span data-i18n="node-red:common.label.password"></span></label>
        <input type="password" id="node-config-input-password">
    </div>
    <div class="form-row">
        <label for="node-config-input-name"><i class="fa fa-tag"></i> <span data-i18n="node-red:common.label.name"></span></label>
        <input type="text" id="node-config-input-name" data-i18n="[placeholder]node-red:common.label.name">
    </div>
</script>

<script type="text/javascript">
    RED.nodes.registerType('tado-config', {
        category: 'config',
        color: "rgb(218, 196, 180)",
        defaults: {
            name: { value: "" }
        },
        credentials: {
            username: { type: "text" },
            password: { type: "password" }
        },
        label: function () {
            return this.name || "Tado Config";
        }
    });
</script>

<script type="text/x-red" data-template-name="tado">
    <div class="form-row">
        <label for="node-input-configName"><i class="fa fa-server"></i> <span data-i18n="tado.label.config-name"></span></label>
        <input type="text" id="node-input-configName">
    </div>
    <div class="form-row">
        <label for="node-input-apiCall"><i class="fa fa-bolt"></i> <span data-i18n="tado.label.api-call"></span></label>
        <select id="node-input-apiCall" style="width:60%; margin-right:5px;">
            <optgroup data-i18n="[label]tado.optgroup.account">
                <option value="getMe" data-i18n="tado.option.get-me"></option>
            </optgroup>
            <optgroup data-i18n="[label]tado.optgroup.home">
                <option value="getHome" data-i18n="tado.option.get-home"></option>
                <option value="getState" data-i18n="tado.option.get-state"></option>
                <option value="getUsers" data-i18n="tado.option.get-users"></option>
                <option value="getInstallations" data-i18n="tado.option.get-installations"></option>
                <option value="getWeather" data-i18n="tado.option.get-weather"></option>
                <option value="getAirComfort" data-i18n="tado.option.get-air-comfort"></option>
                <option value="getAirComfortDetailed" data-i18n="tado.option.get-air-comfort-detailed"></option>
            </optgroup>
            <optgroup data-i18n="[label]tado.optgroup.zone">
                <option value="getZones" data-i18n="tado.option.get-zones"></option>
                <option value="getZoneState" data-i18n="tado.option.get-zone-state"></option>
                <option value="getZoneCapabilities" data-i18n="tado.option.get-zone-capabilities"></option>
                <option value="getZoneDayReport" data-i18n="tado.option.get-zone-day-report"></option>
                <option value="getZoneOverlay" data-i18n="tado.option.get-zone-overlay"></option>
                <option value="setZoneOverlay" data-i18n="tado.option.set-zone-overlay"></option>
                <option value="setZoneOverlays" data-i18n="tado.option.set-zone-overlays"></option>
                <option value="getTimeTables" data-i18n="tado.option.get-timetables"></option>
                <option value="getTimeTable" data-i18n="tado.option.get-timetable"></option>
                <option value="getAwayConfiguration" data-i18n="tado.option.get-away-configuration"></option>
                <option value="clearZoneOverlay" data-i18n="tado.option.clear-zone-overlay"></option>
                <option value="clearZoneOverlays" data-i18n="tado.option.clear-zone-overlays"></option>
                <option value="setOpenWindowMode" data-i18n="tado.option.set-open-window"></option>
            </optgroup>
            <optgroup data-i18n="[label]tado.optgroup.device">
                <option value="setWindowDetection" data-i18n="tado.option.set-window-detection"></option>
                <option value="getDevices" data-i18n="tado.option.get-devices"></option>
                <option value="getDeviceTemperatureOffset" data-i18n="tado.option.get-device-temperature-offset"></option>
                <option value="identifyDevice" data-i18n="tado.option.identify-device"></option>
                <option value="setDeviceTemperatureOffset" data-i18n="tado.option.set-device-temperature-offset"></option>
            </optgroup>
            <optgroup data-i18n="[label]tado.optgroup.mobiledevice">
                <option value="getMobileDevices" data-i18n="tado.option.get-mobile-devices"></option>
                <option value="getMobileDevice" data-i18n="tado.option.get-mobile-device"></option>
                <option value="getMobileDeviceSettings" data-i18n="tado.option.get-mobile-device-settings"></option>
                <option value="setGeoTracking" data-i18n="tado.option.set-geo-tracking"></option>
            </optgroup>
            <optgroup data-i18n="[label]tado.optgroup.presence">
                <option value="isAnyoneAtHome" data-i18n="tado.option.is-anyone-at-home"></option>
                <option value="setPresence" data-i18n="tado.option.set-presence"></option>
                <option value="updatePresence" data-i18n="tado.option.update-presence"></option>
            </optgroup>
        </select>
    </div>
    <div class="form-row" id="tadoHomeId">
        <label for="node-input-homeId"><i class="fa fa-home"></i> <span data-i18n="tado.label.home-id"></span></label>
        <input type="text" id="node-input-homeId" data-i18n="[placeholder]tado.label.home-id">
    </div>
    <div class="form-row" id="tadoDeviceId">
        <label for="node-input-deviceId"><i class="fa fa-mobile"></i> <span data-i18n="tado.label.device-id"></span></label>
        <input type="text" id="node-input-deviceId" data-i18n="[placeholder]tado.label.device-id">
    </div>
    <div class="form-row" id="tadoZoneId">
        <label for="node-input-zoneId"><i class="fa fa-th"></i> <span data-i18n="tado.label.zone-id"></span></label>
        <input type="text" id="node-input-zoneId" data-i18n="[placeholder]tado.label.zone-id">
    </div>
    <div class="form-row" id="tadoTimetableId">
        <label for="node-input-timetableId"><i class="fa fa-home"></i> <span data-i18n="tado.label.timetable-id"></span></label>
        <input type="text" id="node-input-timetableId" data-i18n="[placeholder]tado.label.timetable-id">
    </div>
    <div class="form-row" id="tadoReportDate">
        <label for="node-input-reportDate"><i class="fa fa-th"></i> <span data-i18n="tado.label.reportDate"></span></label>
        <input type="text" id="node-input-reportDate" data-i18n="[placeholder]tado.label.reportDate">
    </div>
    <div id="tadoOverlayForm">
        <div class="form-row" id="tadoPower">
            <label for="node-input-power"><i class="fa fa-power-off"></i> <span data-i18n="tado.label.power"></span></label>
            <select id="node-input-power" style="width:60%; margin-right:5px;">
                <option value="on" data-i18n="tado.option.on"></option>
                <option value="off" data-i18n="tado.option.off"></option>
            </select>
        </div>
        <div id="tadoPowerForm">
            <div class="form-row" id="tadoTemperature">
                <label for="node-input-temperature"><i class="fa fa-thermometer-half"></i> <span data-i18n="tado.label.temperature"></span></label>
                <input type="text" id="node-input-temperature" data-i18n="[placeholder]tado.label.temperature">
            </div>
            <div class="form-row" id="tadoTerminationType">
                <label for="node-input-terminationType"><i class="fa fa-ban"></i> <span data-i18n="tado.label.termination-type"></span></label>
                <select id="node-input-terminationType" style="width:60%; margin-right:5px;">
                    <option value="manual" data-i18n="tado.option.manual"></option>
                    <option value="auto" data-i18n="tado.option.auto"></option>
                    <option value="timer" data-i18n="tado.option.timer"></option>
                </select>
            </div>
            <div class="form-row" id="tadoTerminationTimeout">
                <label for="node-input-terminationTimeout"><i class="fa fa-history"></i> <span data-i18n="tado.label.termination-timeout"></span></label>
                <input type="text" id="node-input-terminationTimeout" data-i18n="[placeholder]tado.label.temperature-timeout">
            </div>
            <div class="form-row" id="tadoFanSpeed">
                <label for="node-input-fanSpeed"><i class="fa fa-tachometer"></i> <span data-i18n="tado.label.fan-speed"></span></label>
                <select id="node-input-fanSpeed" style="width:60%; margin-right:5px;">
                    <option value="AUTO" data-i18n="tado.option.auto-fan"></option>
                    <option value="LOW" data-i18n="tado.option.low"></option>
                    <option value="MIDDLE" data-i18n="tado.option.middle"></option>
                    <option value="HIGH" data-i18n="tado.option.high"></option>
                </select>
            </div>
            <div class="form-row" id="tadoAcMode">
                <label for="node-input-acMode"><i class="fa fa-random"></i> <span data-i18n="tado.label.ac-mode"></span></label>
                <select id="node-input-acMode" style="width:60%; margin-right:5px;">
                    <option value="AUTO" data-i18n="tado.option.auto-fan"></option>
                    <option value="COOL" data-i18n="tado.option.cool"></option>
                    <option value="DRY" data-i18n="tado.option.dry"></option>
                    <option value="FAN" data-i18n="tado.option.fan"></option>
                    <option value="HEAT" data-i18n="tado.option.heat"></option>
                </select>
            </div>
            <div class="form-row" id="tadoVertSwing">
                <label for="node-input-VertSwing"><i class="fa fa-arrow-up-arrow-down"></i> <span data-i18n="tado.label.VertSwing"></span></label>
                <select id="node-input-VertSwing" style="width:60%; margin-right:5px;">
                    <option value="on" data-i18n="tado.option.on"></option>
                    <option value="off" data-i18n="tado.option.off"></option>
                </select>
            </div>
            <div class="form-row" id="tadoHorizSwing">
                <label for="node-input-HorizSwing"><i class="fa fa-arrow-right-arrow-left"></i> <span data-i18n="tado.label.HorizSwing"></span></label>
                <select id="node-input-HorizSwing" style="width:60%; margin-right:5px;">
                    <option value="on" data-i18n="tado.option.on"></option>
                    <option value="off" data-i18n="tado.option.off"></option>
                </select>
            </div>
            <div class="form-row" id="tadoLight">
                <label for="node-input-Light"><i class="fa fa-lightbulb"></i> <span data-i18n="tado.label.Light"></span></label>
                <select id="node-input-Light" style="width:60%; margin-right:5px;">
                    <option value="on" data-i18n="tado.option.on"></option>
                    <option value="off" data-i18n="tado.option.off"></option>
                </select>
            </div>
        </div>
    </div>
    <div class="form-row" id="tadoTemperatureOffset">
        <label for="node-input-temperatureOffset"><i class="fa fa-thermometer-half"></i> <span data-i18n="tado.label.temperature-offset"></span></label>
        <input type="text" id="node-input-temperatureOffset" data-i18n="[placeholder]tado.label.temperature-offset">
    </div>
    <div class="form-row" id="tadoPresence">
        <label for="node-input-presence"><i class="fa fa-map-marker"></i> <span data-i18n="tado.label.presence"></span></label>
        <select id="node-input-presence" style="width:60%; margin-right:5px;">
            <option value="HOME" data-i18n="tado.option.home"></option>
            <option value="AWAY" data-i18n="tado.option.away"></option>
            <option value="AUTO" data-i18n="tado.option.auto-presence"></option>
        </select>
    </div>
    <div class="form-row" id="tadoGeoTracking">
        <label for="node-input-geoTracking"><i class="fa fa-map-marker"></i> <span data-i18n="tado.label.geo-tracking"></span></label>
        <select id="node-input-geoTracking" style="width:60%; margin-right:5px;">
            <option value="true" data-i18n="tado.option.enabled"></option>
            <option value="false" data-i18n="tado.option.disabled"></option>
        </select>
    </div>
    <div id="tadoWindowDetectionForm">
        <div class="form-row">
            <label for="node-input-windowDetection"><i class="fa fa-windows"></i> <span data-i18n="tado.label.window-detection"></span></label>
            <select id="node-input-windowDetection" style="width:60%; margin-right:5px;">
                <option value="true" data-i18n="tado.option.enabled"></option>
                <option value="false" data-i18n="tado.option.disabled"></option>
            </select>
        </div>
        <div class="form-row">
            <label for="node-input-windowDetectionTimeout"><i class="fa fa-windows"></i> <span data-i18n="tado.label.window-detection-timeout"></span></label>
            <input type="text" id="node-input-windowDetectionTimeout" data-i18n="[placeholder]tado.label.window-detection-timeout">
        </div>
    </div>
    <div id="tadoOpenWindowMode">
        <div class="form-row">
            <label for="node-input-openWindowMode"><i class="fa fa-windows"></i> <span data-i18n="tado.label.open-window-mode"></span></label>
            <select id="node-input-openWindowMode" style="width:60%; margin-right:5px;">
                <option value="true" data-i18n="tado.option.activate"></option>
                <option value="false" data-i18n="tado.option.cancel"></option>
            </select>
        </div>
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="node-red:common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]node-red:common.label.name">
    </div>
</script>

<script type="text/x-red" data-help-name="tado">
    <p>A Tado Web API node.</p>

    <h3>Inputs</h3>
    <dl class="message-properties">
        <dt class="optional">apiCall <span class="property-type">string</span></dt>
        <dd> the API call to be made</dd>

        <dt class="optional">homeId <span class="property-type">string</span></dt>
        <dd> the home ID to target</dd>

        <dt class="optional">deviceId <span class="property-type">string</span></dt>
        <dd> the device ID to target</dd>

        <dt class="optional">zoneId <span class="property-type">string</span></dt>
        <dd> the zone ID to target</dd>

        <dt class="optional">timetableId <span class="property-type">string</span></dt>
        <dd> the timetable ID to target</dd>

        <dt class="optional">power <span class="property-type">string</span></dt>
        <dd> turn the heating system <code>"on"</code> or <code>"off"</code></dd>

        <dt class="optional">reportDate <span class="property-type">string</span></dt>
        <dd> the date in <code>yyyy-mm-dd</code> notation to fetch the report data from</dd>

        <dt class="optional">temperature <span class="property-type">string</span></dt>
        <dd> the target temperature</dd>

        <dt class="optional">terminationType <span class="property-type">string</span></dt>
        <dd> <code>"manual"</code>, <code>"auto"</code> or <code>"timer"</code></dd>

        <dt class="optional">terminationTimeout <span class="property-type">string</span></dt>
        <dd> the timeout in seconds to clear the overlay</dd>

        <dt class="optional">fanSpeed <span class="property-type">string</span></dt>
        <dd> the speed of the fan in an AC system (AUTO, LOW, MIDDLE, HIGH)</dd>

        <dt class="optional">acMode <span class="property-type">string</span></dt>
        <dd> the mode of the AC system (AUTO, COOL, DRY, FAN, HEAT)</dd>

        <dt class="optional">presence <span class="property-type">string</span></dt>
        <dd> <code>"home"</code>, <code>"away"</code> or <code>"auto"</code></dd>

        <dt class="optional">geoTracking <span class="property-type">boolean</span></dt>
        <dd> Enabled or disable Geo Tracking on a device</dd>

        <dt class="optional">windowDetection <span class="property-type">boolean</span></dt>
        <dd> Enable or disable window detection for a zone</dd>

        <dt class="optional">windowDetectionTimeout <span class="property-type">number</span></dt>
        <dd> How long should window detection shut-off the heating for</dd>

        <dt class="optional">openWindowMode <span class="property-type">boolean</span></dt>
        <dd> Activate or cancel open window mode for a zone</dd>
    </dl>

    <h3>Outputs</h3>
    <dl class="message-properties">
        <dt>topic <span class="property-type">object</span></dt>
        <dd> the API call</dd>
        <dt>payload <span class="property-type">object</span></dt>
        <dd> the response from Tado</dd>
    </dl>

    <h3>Details</h3>
    <p>Incoming messages trigger the API call. If the incoming message contains any of the optional fields then that node property is overwritten.</p>
    <p><code>msg.topic</code> indicates the API call that generated the response. <code>msg.payload</code> is the response from Tado</p>
    <p>For more information about the API responses see <a href="https://github.com/mattdavis90/node-tado-client">node-tado-client</a></p>

    <h3>References</h3>
    <ul>
        <li><a href="http://blog.scphillips.com/posts/2017/01/the-tado-api-v2/">SCPhillips Blog</a></li>
    </ul>
</script>

<script type="text/javascript">
    RED.nodes.registerType('tado', {
        category: 'heating',
        color: "rgb(255, 255, 255)",
        defaults: {
            configName: { type: "tado-config", required: true },
            apiCall: { value: "getMe" },
            homeId: { value: "" },
            deviceId: { value: "" },
            zoneId: { value: "" },
            power: { value: "on" },
            temperature: { value: "18" },
            terminationType: { value: "manual" },
            terminationTimeout: { value: 900, validate: RED.validators.number() },
            fanSpeed: { value: "AUTO" },
            acMode: { value: "AUTO" },
            name: { value: "" },
            reportDate: { value: "" },
            presence: { value: "HOME" },
            geoTracking: { value: true },
            temperatureOffset: { value: 0 },
            windowDetection: { value: true },
            windowDetectionTimeout: { value: 900 },
            openWindowMode: { value: true },
            timetableId: { value: "" },
        },
        inputs: 1,
        outputs: 1,
        icon: "tado.png",
        label: function () {
            return this.name || "Tado";
        },
        labelStyle: function () {
            return this.name ? "node_label_italic" : "";
        },
        oneditprepare: function () {
            $('#node-input-apiCall').change(function () {
                const apiCall = $('#node-input-apiCall').val();

                const home = $('#tadoHomeId');
                const zone = $('#tadoZoneId');
                const device = $('#tadoDeviceId');
                const overlay = $('#tadoOverlayForm');
                const reportDate = $('#tadoReportDate');
                const presence = $('#tadoPresence');
                const temperatureOffset = $('#tadoTemperatureOffset');
                const geoTracking = $('#tadoGeoTracking');
                const windowDetection = $('#tadoWindowDetectionForm');
                const windowMode = $('#tadoOpenWindowMode');
                const timetable = $('#tadoTimetableId');

                [
                    home,
                    zone,
                    device,
                    overlay,
                    reportDate,
                    presence,
                    temperatureOffset,
                    geoTracking,
                    windowDetection,
                    windowMode,
                    timetable,
                ].forEach(e => e.hide());

                switch (apiCall) {
                    case "getMe":
                        break;
                    case "getHome":
                        home.show();
                        break;
                    case "getWeather":
                        home.show();
                        break;
                    case "getDevices":
                        home.show();
                        break;
                    case "getDeviceTemperatureOffset":
                        device.show();
                        break;
                    case "getInstallations":
                        home.show();
                        break;
                    case "getUsers":
                        home.show();
                        break;
                    case "getState":
                        home.show();
                        break;
                    case "getMobileDevices":
                        home.show();
                        break;
                    case "getMobileDevice":
                        home.show();
                        device.show();
                        break;
                    case "getMobileDeviceSettings":
                        home.show();
                        device.show();
                        break;
                    case "setGeoTracking":
                        home.show();
                        device.show();
                        geoTracking.show();
                        break;
                    case "getZones":
                        home.show();
                        break;
                    case "getZoneState":
                        home.show();
                        zone.show();
                        break;
                    case "getZoneCapabilities":
                        home.show();
                        zone.show();
                        break;
                    case "getZoneOverlay":
                        home.show();
                        zone.show();
                        break;
                    case "getZoneDayReport":
                        home.show();
                        zone.show();
                        reportDate.show();
                        break;
                    case "getTimeTables":
                        home.show();
                        zone.show();
                        break;
                    case "getAwayConfiguration":
                        home.show();
                        zone.show();
                        break;
                    case "getTimeTable":
                        home.show();
                        zone.show();
                        timetable.show();
                        break;
                    case "clearZoneOverlay":
                        home.show();
                        zone.show();
                        break;
                    case "clearZoneOverlays":
                        home.show();
                        zone.show();
                        break;
                    case "setZoneOverlay":
                        home.show();
                        zone.show();
                        overlay.show();
                        break;
                    case "setZoneOverlays":
                        home.show();
                        zone.show();
                        overlay.show();
                        break;
                    case "setDeviceTemperatureOffset":
                        device.show();
                        temperatureOffset.show();
                        break;
                    case "identifyDevice":
                        device.show();
                        break;
                    case "setPresence":
                        home.show();
                        presence.show();
                        break;
                    case "isAnyoneAtHome":
                        home.show();
                        break;
                    case "updatePresence":
                        home.show();
                        break;
                    case "setWindowDetection":
                        home.show();
                        zone.show();
                        windowDetection.show();
                        break;
                    case "setOpenWindowMode":
                        home.show();
                        zone.show();
                        windowMode.show();
                        break;
                    case "getAirComfort":
                        home.show();
                        break;
                    case "getAirComfortDetailed":
                        home.show();
                        break;
                }
            });

            $('#node-input-power').change(function () {
                const power = $('#node-input-power').val();
                switch (power) {
                    case "on":
                        $('#tadoPowerForm').show();
                        break;
                    case "off":
                        $('#tadoPowerForm').hide();
                        break;
                }
            });

            $('#node-input-terminationType').change(function () {
                const terminationType = $('#node-input-terminationType').val();
                switch (terminationType) {
                    case "manual":
                    case "auto":
                        $('#tadoTerminationTimeout').hide();
                        break;
                    case "timer":
                        $('#tadoTerminationTimeout').show();
                        break;
                }
            });
        }
    });
</script>
